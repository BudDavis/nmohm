<!DOCTYPE html>
<html lang="en">
<head>
  <title>NMoHM CAE Experience</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="bootstrap-5.3.0-dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="bootstrap-5.3.0-dist/js/bootstrap.bundle.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="leaflet.css"/>
        <script src="leaflet.js"></script>
       <style>
            html, body, #map {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
        </style>

</head>
<body>
<div class="p-5 bg-primary text-white text-center">
  <h1>NMoHM CAE Experience Control</h1>
  <p></p>
</div>


<div class="container mt-3">
  <p></p>            
  <table class="table">
    <thead>
        <th id="podname1"></th> 
        <th>Station</th> 
        <th>Role</th> 
        <th id="Mode">Mode</th> 
        <th>Time</th> 
        <th id="KML File">Waypoint File</th> 
    </thead>
    <tbody>
      <tr>
        <td id=stationonline1></td>
        <td id="stationid1"></td> 
        <td id="stationrole1"></td> 
        <td id="stationmode1"></td> 
        <td id="stationelapsedtime1"</td> 
        <td id="stationkmlfile1"</td> 
      </tr>
      <tr>
        <td id=stationonline2></td>
        <td id="stationid2"></td> 
        <td id="stationrole2"></td> 
        <td id="stationmode2"></td> 
        <td id="stationelapsedtime2"</td> 
        <td id="stationkmlfile2"</td> 
      </tr>
      <tr> 
        <td id=stationonline3></td>
        <td id="stationid3"></td> 
        <td id="stationrole3"></td> 
        <td id="stationmode3"></td> 
        <td id="stationelapsedtime3"</td> 
        <td id="stationkmlfile3"</td> 
      </tr>
    </tbody>
  </table>
  <div class="container-fluid">
     <button type="button" class="btn btn-primary" onclick="pod_cmd(1,`RUN`)">Run</button>
     <button type="button" class="btn btn-secondary" onclick="pod_cmd(1,`FREEZE`)">Freeze</button>
     <button type="button" class="btn btn-success" onclick="pod_cmd(1,`RESET`)">Reset</button>
     <input class="form-inline" type="file" id="formFile1"></input>
     <button type="button" class="btn btn-danger"  onclick="load_file(1)">Load</button>
  </div>
  <table class="table">
    <thead>
        <th id="podname2"></th> 
        <th>Station</th> 
        <th>Role</th> 
        <th id="Mode">Mode</th> 
        <th>Time</th> 
        <th id="KML File">Waypoint File</th> 
    </thead>
    <tbody>
      <tr>
        <td id=stationonline4></td>
        <td id="stationid4"></td> 
        <td id="stationrole4"></td> 
        <td id="stationmode4"></td> 
        <td id="stationelapsedtime4"</td> 
        <td id="stationkmlfile4"</td> 
      </tr>
      <tr>
        <td id=stationonline5></td>
        <td id="stationid5"></td> 
        <td id="stationrole5"></td> 
        <td id="stationmode5"></td> 
        <td id="stationelapsedtime5"</td> 
        <td id="stationkmlfile5"</td> 
      </tr>
      </tr>
        <td id=stationonline6></td>
        <td id="stationid6"></td> 
        <td id="stationrole6"></td> 
        <td id="stationmode6"></td> 
        <td id="stationelapsedtime6"</td> 
        <td id="stationkmlfile6"</td> 
      </tr>
    </tbody>
  </table>
  <div class="container-fluid">
     <button type="button" class="btn btn-primary" onclick="pod_cmd(2,`RUN`)">Run</button>
     <button type="button" class="btn btn-secondary" onclick="pod_cmd(2,`FREEZE`)">Freeze</button>
     <button type="button" class="btn btn-success" onclick="pod_cmd(2,`RESET`)">Reset</button>
     <input class="form-inline" type="file" id="formFile2"></input>
     <button type="button" class="btn btn-danger"  onclick="load_file(2)">Load</button>
  </div>
  <table class="table">
    <thead>
        <th id="podname3"></th> 
        <th>Station</th> 
        <th>Role</th> 
        <th id="Mode">Mode</th> 
        <th>Time</th> 
        <th id="KML File">Waypoint File</th> 
    </thead>
    <tbody>
      <tr>
        <td id=stationonline7></td>
        <td id="stationid7"></td> 
        <td id="stationrole7"></td> 
        <td id="stationmode7"></td> 
        <td id="stationelapsedtime7"</td> 
        <td id="stationkmlfile7"</td> 
      </tr>
      <tr>
        <td id=stationonline8></td>
        <td id="stationid8"></td> 
        <td id="stationrole8"></td> 
        <td id="stationmode8"></td> 
        <td id="stationelapsedtime8"</td> 
        <td id="stationkmlfile8"</td> 
      </tr>
      <tr>
        <td id=stationonline9></td>
        <td id="stationid9"></td> 
        <td id="stationrole9"></td> 
        <td id="stationmode9"></td> 
        <td id="stationelapsedtime9"</td> 
        <td id="stationkmlfile9"</td> 
      </tr>
    </tbody>
  </table>
  <div class="container-fluid">
     <button type="button" class="btn btn-primary" onclick="pod_cmd(3,`RUN`)">Run</button>
     <button type="button" class="btn btn-secondary" onclick="pod_cmd(3,`FREEZE`)">Freeze</button>
     <button type="button" class="btn btn-success" onclick="pod_cmd(3,`RESET`)">Reset</button>
     <input class="form-inline" type="file" id="formFile3"></input>
     <button type="button" class="btn btn-danger"  onclick="load_file(3)">Load</button>
  </div>
</div>

<div id="map"></div>


<div class="container mt-5">
  <div class="row">
    <div class="col-sm-4">
      <h2>About Me</h2>
      <h5>Photo of me:</h5>
      <div class="fakeimg">Fake Image</div>
      <p>Some text about me in culpa qui officia deserunt mollit anim..</p>
      <h3 class="mt-4">Some Links</h3>
      <p>Lorem ipsum dolor sit ame.</p>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#">Active</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" href="#">Disabled</a>
        </li>
      </ul>
      <hr class="d-sm-none">
    </div>
    <div class="col-sm-8">
      <h2>TITLE HEADING</h2>
      <h5>Title description, Dec 7, 2020</h5>
      <div class="fakeimg">Fake Image</div>
      <p>Some text..</p>
      <p>Sunt in culpa qui officia deserunt mollit anim id est laborum consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>

      <h2 class="mt-5">TITLE HEADING</h2>
      <h5>Title description, Sep 2, 2020</h5>
      <div class="fakeimg">Fake Image</div>
      <p>Some text..</p>
      <p>Sunt in culpa qui officia deserunt mollit anim id est laborum consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>
    </div>
  </div>
</div>

<div class="mt-5 p-4 bg-dark text-white text-center">
  <p>Footer</p>
</div>

</body>
</html>



<script>

  // A Station is a computer supporting one user of the experience
class Station {
  constructor(url,role,id,kmlfile) {
          this.url = url;
          this.role =role;
          this.ws = null;
          this.id = id;
          this.kmlfile = kmlfile;
  }
}


  // A Pod is a group of stations that are going through the experience together
  // Notionally, a Pod is 3 Stations
class Pod {
  constructor(S,name) {
    this.stations = S;
    this.name = name;
  }
} 

  // system definitions.  perhaps these should be in a file?
  var Pods = [ new Pod( [ new Station("ws://localhost:8001","COPILOT",1,"dustoff.kml"),
                          new Station("ws://localhost:8001","MEDIC",2,"dustoff2.kml"), 
                          new Station("ws://localhost:8001","CREWCHIEF",3,"dustoff3.kml") ], "A Pod" ),
               new Pod( [ new Station("ws://localhost:8001","MEDIC",4,"blahblah.kml"), 
                          new Station("ws://localhost:8001","CREWCHIEF",5,"abc.kml"), 
                          new Station("ws://localhost:8001","COPILOT",6,"xxx.kml") ] ,"B Pod" ),
               new Pod( [ new Station("ws://localhost:8001","CREWCHIEF",7,"123.kml"), 
                          new Station("ws://localhost:8001","COPILOT",8,"456.kml"), 
                          new Station("ws://localhost:8001","MEDIC",9,"thelast.kml") ] ,"C Pod" )
             ];


  window.onload = function() {
  // This function initializes objects when the page completes loading
  // Not everything is initialized
        let idx=0;
        let jdx=0;
        for (let P of Pods) {
             idx++; 
             document.getElementById("podname"+idx).innerHTML = P.name;
            for (let S of P.stations) {
               jdx++;
               document.getElementById("stationid"+jdx).innerHTML = S.id;
               document.getElementById("stationrole"+jdx).innerHTML = S.role;
            }
        }
  }




 
  function open_pod_connections(PS){
    // This function will attempt to open any ws connection that it can.
    // it will do nothing to connections that are already opened.
    // it is expected to call this function periodically.
    for (let P of PS) {
      for (let S of P.stations) {
          if (S.ws == null){
            // open
            S.ws = new WebSocket(S.url);
            S.ws.addEventListener("open", ({ data }) => {
                                    document.getElementById("stationonline" + S.id ).innerHTML = "online";
                                    // This init message may not be required, but for debugging it is
                                    // nice to see where the message came from
                                    S.ws.send(JSON.stringify({cmd:"INIT",id:S.id}));
                                    //S.ws.send(JSON.stringify({cmd,"INIT\",\"id\":\"" + S.id + "\"}");
                                    //S.ws.send("{\"cmd\":\"INIT\",\"id\":\"" + S.id + "\"}");
                               });
            // close
            S.ws.addEventListener("close", ({ data }) => {
                                    S.ws = null;
                                    console.log("close event " + S.id);
                                    document.getElementById("stationonline" + S.id ).innerHTML = "offline";
                               });
            // on message
            S.ws.addEventListener("message", ({ data }) => {
                                    //console.log("message event " + S.id);
                                    //console.log(data);
                                    const obj = JSON.parse(data);
                                    if (obj.cmd=="STATUS" || obj.cmd=="status") {
                                        console.log("this is status");
                                        S.kmlfile = obj.kmlfile;
                                        //S.role = obj.role;
                                        S.mode = obj.mode;
                                        var jdx = S.id;
                                        //document.getElementById("stationrole"+jdx).innerHTML = S.role;
                                        document.getElementById("stationmode"+jdx).innerHTML = S.mode;
                                        document.getElementById("stationkmlfile"+jdx).innerHTML = S.kmlfile;
                                        var dt = obj.elapsedtime - S.elapsedtime;

                                        S.elapsedtime = Math.round(obj.elapsedtime);
                                        var min = Math.trunc(S.elapsedtime/60);
                                        var sec = S.elapsedtime - (min*60);
                                        if (sec < 10) {
                                           // instead of :1 i want :01 in the output
                                           // all the way to 9
                                           const lut = ["00","01","02","03","04","05","06","07","08","09"]; 
                                           document.getElementById("stationelapsedtime"+jdx).innerHTML = min.toString() + ":" + lut[sec];
                                        }
                                        else {
                                           document.getElementById("stationelapsedtime"+jdx).innerHTML = min.toString() + ":" + sec.toString();
                                        }
                                    }
                               });
            // on error
            S.ws.addEventListener("error", ({ data }) => {
                                    document.getElementById("stationonline" + S.id ).innerHTML = "error";
                                    console.log("error event " + S.id);
                               });
          }
      }
    }
  }


  function request_pod_status(PS){
    // it is expected to call this function periodically.
    for (let P of PS) {
      var jdx = 0;
      for (let S of P.stations) {
          if (S.ws != null && S.ws.readyState == WebSocket.OPEN){
            // open
            S.ws.send("{\"cmd\":\"STATUSREQUEST\"}");
          }
          jdx++;
      }
    }
  }


  function p(){
     open_pod_connections(Pods);
  }
  setInterval(p,10000);




  function r(){
     // These are functions that are done on a periodic basis
     request_pod_status(Pods);
     // check for changed Pod state
  }
  setInterval(r,5000);




  // these are ugly, and could be done a lot better
  function pod_cmd(podnum,cmd)
  {
      console.log("in run_pod " + podnum);
      var P = Pods[podnum-1];
      for (var S of P.stations) {
          if (S.ws != null){
             var t = {cmd:cmd,id:S.id};
             S.ws.send(JSON.stringify(t));

             //S.ws.send("{\"cmd\":\"" + cmd + "\"}");
          }
      }
  }
  function load_file(podnum)
  {
      var P = Pods[podnum-1];
      var fname = document.getElementById("formFile"+podnum).value;
      for (let S of P.stations) {
          if (S.ws != null){
             var t = {cmd:"WAYPOINTFILE",filename:fname,id:S.id};
             S.ws.send(JSON.stringify(t));
          }
      }
  }

  var map = L.map('map').setView([0, 0], 3);

  //L.tileLayer('http://localhost:8080/tile/{z}/{x}/{y}.png', {
  //              maxZoom: 18,
  //              attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
  //              id: 'base'
  //          }).addTo(map);

// set tabstop=2 shiftwidth=2 expandtab   
// retab
</script>
