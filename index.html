<!DOCTYPE html>
<html lang="en">
<head>
  <title>NMoHM CAE Experience</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="bootstrap-5.3.0-dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="bootstrap-5.3.0-dist/js/bootstrap.bundle.min.js"></script>
  <style>
  .fakeimg {
    height: 200px;
    background: #aaa;
  }
  </style>
</head>
<body>
<div class="p-5 bg-primary text-white text-center">
  <h1>NMoHM CAE Experience Control</h1>
  <p></p>
</div>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
  <div class="container-fluid">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="#">Active</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Link</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Link</a>
      </li>
      <li class="nav-item">
        <a class="nav-link disabled" href="#">Disabled</a>
      </li>
    </ul>
  </div>
</nav>



<div class="container mt-3">
  <p></p>            
  <table class="table">
    <thead>
        <th id="podname1"></th> 
        <th>Station</th> 
        <th>Role</th> 
        <th id="Mode">Mode</th> 
        <th>Time</th> 
        <th id="KML File">Waypoint File</th> 
    </thead>
    <tbody>
      <tr>
        <td></td>
        <td id="stationid1"></td> 
        <td id="stationrole1"></td> 
        <td id="stationmode1"></td> 
        <td id="stationelapsedtime1"</td> 
        <td id="stationkmlfile1"</td> 
      </tr>
      <tr>
        <td></td>
        <td id="stationid2"></td> 
        <td id="stationrole2"></td> 
        <td id="stationmode2"></td> 
        <td id="stationelapsedtime2"</td> 
        <td id="stationkmlfile2"</td> 
      </tr>
      <tr> 
        <td></td>
        <td id="stationid3"></td> 
        <td id="stationrole3"></td> 
        <td id="stationmode3"></td> 
        <td id="stationelapsedtime3"</td> 
        <td id="stationkmlfile3"</td> 
      </tr>
    </tbody>
  </table>
  <table class="table">
    <thead>
        <th id="podname2"></th> 
    </thead>
    <tbody>
      <tr>
        <td></td>
        <td id="stationid4"></td> 
        <td id="stationrole4"></td> 
        <td id="stationmode4"></td> 
        <td id="stationelapsedtime4"</td> 
        <td id="stationkmlfile4"</td> 
      </tr>
      <tr>
        <td></td>
        <td id="stationid5"></td> 
        <td id="stationrole5"></td> 
        <td id="stationmode5"></td> 
        <td id="stationelapsedtime5"</td> 
        <td id="stationkmlfile5"</td> 
      </tr>
      </td>
        <td></td>
        <td id="stationid6"></td> 
        <td id="stationrole6"></td> 
        <td id="stationmode6"></td> 
        <td id="stationelapsedtime6"</td> 
        <td id="stationkmlfile6"</td> 
      </tr>
    </tbody>
  </table>
  <table class="table">
    <thead>
        <th id="podname3"></th> 
    </thead>
    <tbody>
      <tr>
        <td></td>
        <td id="stationid7"></td> 
        <td id="stationrole7"></td> 
        <td id="stationmode7"></td> 
        <td id="stationelapsedtime7"</td> 
        <td id="stationkmlfile7"</td> 
      </tr>
      <tr>
        <td></td>
        <td id="stationid8"></td> 
        <td id="stationrole8"></td> 
        <td id="stationmode8"></td> 
        <td id="stationelapsedtime8"</td> 
        <td id="stationkmlfile8"</td> 
      </tr>
      <tr>
        <td></td>
        <td id="stationid9"></td> 
        <td id="stationrole9"></td> 
        <td id="stationmode9"></td> 
        <td id="stationelapsedtime9"</td> 
        <td id="stationkmlfile9"</td> 
      </tr>
    </tbody>
  </table>
</div>

</div>
</div>

</div>



<div class="container mt-5">
  <div class="row">
    <div class="col-sm-4">
      <h2>About Me</h2>
      <h5>Photo of me:</h5>
      <div class="fakeimg">Fake Image</div>
      <p>Some text about me in culpa qui officia deserunt mollit anim..</p>
      <h3 class="mt-4">Some Links</h3>
      <p>Lorem ipsum dolor sit ame.</p>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#">Active</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Link</a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" href="#">Disabled</a>
        </li>
      </ul>
      <hr class="d-sm-none">
    </div>
    <div class="col-sm-8">
      <h2>TITLE HEADING</h2>
      <h5>Title description, Dec 7, 2020</h5>
      <div class="fakeimg">Fake Image</div>
      <p>Some text..</p>
      <p>Sunt in culpa qui officia deserunt mollit anim id est laborum consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>

      <h2 class="mt-5">TITLE HEADING</h2>
      <h5>Title description, Sep 2, 2020</h5>
      <div class="fakeimg">Fake Image</div>
      <p>Some text..</p>
      <p>Sunt in culpa qui officia deserunt mollit anim id est laborum consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>
    </div>
  </div>
</div>

<div class="mt-5 p-4 bg-dark text-white text-center">
  <p>Footer</p>
</div>

</body>
</html>
<script>

  // A Station is a computer supporting one user of the experience
class Station {
  constructor(url,role,id,kmlfile) {
          this.url = url;
          this.role =role;
          this.ws = null;
          this.id = id;
          this.kmlfile = kmlfile;
  }
}
  // A Pod is a group of stations that are going through the experience together
  // Notionally, a Pod is 3 Stations
class Pod {
  constructor(S,name) {
    this.stations = S;
    this.name = name;
  }
} 

  // system definitions.  perhaps these should be in a file?
  var Pods = [ new Pod( [ new Station("ws://localhost:8001","COPILOT",1,"dustoff.kml") ], "A Pod" )];
             //             new Station("ws://localhost:8001","MEDIC",2), 
             //             new Station("ws://localhost:8001","CREWCHIEF",3) ], "A Pod" ),
             //  new Pod( [ new Station("ws://localhost:8001","MEDIC",4), 
             //             new Station("ws://localhost:8001","CREWCHIEF",5), 
             //             new Station("ws://localhost:8001","COPILOT",6) ] ,"B Pod" )
            //   new Pod( [ new Station("ws://localhost:8001","CREWCHIEF",7), 
            //              new Station("ws://localhost:8001","COPILOT",8), 
            //              new Station("ws://localhost:8001","MEDIC",9) ] ,"C Pod" )
            // ];

  window.onload = function() {
        let idx=0;
        let jdx=0;
        for (let P of Pods) {
             idx=idx+1; 
             document.getElementById("podname"+idx).innerHTML = P.name;
            for (let S of P.stations) {
               jdx=jdx+1;
               document.getElementById("stationid"+jdx).innerHTML = S.id;
               document.getElementById("stationrole"+jdx).innerHTML = S.role;
               document.getElementById("stationmode"+jdx).innerHTML = "run";
            }
        }
  }




 
  function open_pod_connections(PS){
    // This function will attempt to open any ws connection that it can.
    // it will do nothing to connections that are already opened.
    // it is expected to call this function periodically.
    for (let P of PS) {
      for (let S of P.stations) {
          //console.log(P.name + "  " + S.role + "   " + S.url + "  " + S.id + "  " + S.ws);
          if (S.ws == null){
            // open
            console.log(" Opening " + S.id);
            S.ws = new WebSocket(S.url);
            S.ws.addEventListener("open", ({ data }) => {
                                    console.log("open event " + S.id);
                                    var t = S;
                                    t.cmd="CONFIG";
                                    S.ws.send(JSON.stringify(t));
                                    //S.ws.send("{\"cmd\":\"CONFIG\",\"id\":\"" + S.id + "\",\"kmlfile\":\"" + S.kmlfile + "\"}");
                               });
            // close
            S.ws.addEventListener("close", ({ data }) => {
                                    S.ws = null;
                                    console.log("close event " + S.id);
                               });
            // on message
            S.ws.addEventListener("message", ({ data }) => {
                                    console.log("message event " + S.id);
                                    console.log(data);
                                    const obj = JSON.parse(data);
                                    if (obj.cmd=="STATUS" || obj.cmd=="status") {
                                        console.log("this is status");
                                        S.kmlfile = obj.kmlfile;
                                        S.role = obj.role;
                                        S.mode = obj.mode;
                                        var jdx = S.id;
                                        document.getElementById("stationrole"+jdx).innerHTML = S.role;
                                        document.getElementById("stationmode"+jdx).innerHTML = S.mode;
                                        //document.getElementById("stationelapsedtime"+jdx).innerHTML = "run";
                                        document.getElementById("stationkmlfile"+jdx).innerHTML = S.kmlfile;
                                    }
                               });
            // on error
            S.ws.addEventListener("error", ({ data }) => {
                                    console.log("error event " + S.id);
                               });
          }
      }
    }
  }


  function request_pod_status(PS){
    // it is expected to call this function periodically.
    for (let P of PS) {
      for (let S of P.stations) {
          //console.log(P.name + "  " + S.role + "   " + S.url + "  " + S.id + "  " + S.ws);
          if (S.ws != null && S.ws.readyState == WebSocket.OPEN){
            // open
            S.ws.send("{\"cmd\":\"STATUS\"}");
          }
      }
    }
  }


  function kill_one(){
    // this function is only used for testing.
    // it can be deleted whenever
    Pods[1].stations[1].ws.close();
    Pods[1].stations[1].ws = null;
  }


  function p(){
     open_pod_connections(Pods);
  }
  setInterval(p,10000);




  function r(){
     // These are functions that are done on a periodic basis
     request_pod_status(Pods);
     // check for changed Pod state
  }
  setInterval(r,5000);

// set tabstop=2 shiftwidth=2 expandtab   
// retab
</script>
